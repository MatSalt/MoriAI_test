 Repository ì•„í‚¤í…ì²˜ ë° ë°ì´í„° íë¦„ ì„¤ëª…

  ğŸ“ ì•„í‚¤í…ì²˜ êµ¬ì¡°

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                      FastAPI Endpoints                       â”‚
  â”‚                        (main.py)                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                      BookService                             â”‚
  â”‚              (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, TTS ì—°ë™)                         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚               InMemoryBookRepository                         â”‚
  â”‚           (Write-Through Cache ì „ëµ)                         â”‚
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
  â”‚   â”‚         In-Memory Cache (Dict)              â”‚           â”‚
  â”‚   â”‚    { book_id: Book ê°ì²´ }                   â”‚           â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                FileBookRepository                            â”‚
  â”‚              (íŒŒì¼ ì‹œìŠ¤í…œ I/O ë‹´ë‹¹)                           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   FileManager                                â”‚
  â”‚         (JSON íŒŒì¼ ì €ì¥/ë¡œë“œ, ì´ë¯¸ì§€ ê´€ë¦¬)                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  File System   â”‚
                    â”‚  ./data/book/  â”‚
                    â”‚  ./data/image/ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ---
  ğŸ”„ ë°ì´í„° íë¦„ ìƒì„¸ ì„¤ëª…

  1ï¸âƒ£ AbstractBookRepository (base.py)

  ì—­í• : Repository ì¸í„°í˜ì´ìŠ¤ ì •ì˜ (ì¶”ìƒ í´ë˜ìŠ¤)

  class AbstractBookRepository(ABC):
      @abstractmethod
      async def create(self, book: Book) -> Book

      @abstractmethod
      async def get(self, book_id: str) -> Optional[Book]

      @abstractmethod
      async def get_all(self) -> List[Book]

      @abstractmethod
      async def update(self, book_id: str, book: Book) -> Book

      @abstractmethod
      async def delete(self, book_id: str) -> bool

      @abstractmethod
      async def exists(self, book_id: str) -> bool

  ëª©ì :
  - ë°ì´í„° ì ‘ê·¼ ë¡œì§ì„ ì¶”ìƒí™”
  - ì¶”í›„ PostgreSQL, MongoDB ë“±ìœ¼ë¡œ êµì²´ ê°€ëŠ¥
  - ì˜ì¡´ì„± ì—­ì „ ì›ì¹™(DIP) ì¤€ìˆ˜

  ---
  2ï¸âƒ£ FileBookRepository (file_repository.py)

  ì—­í• : íŒŒì¼ ì‹œìŠ¤í…œ ê¸°ë°˜ ì˜êµ¬ ì €ì¥ì†Œ

  íŠ¹ì§•:
  - âœ… ìˆœìˆ˜ íŒŒì¼ I/Oë§Œ ë‹´ë‹¹ (ìºì‹± ì—†ìŒ)
  - âœ… JSON íŒŒì¼ë¡œ Book ë©”íƒ€ë°ì´í„° ì €ì¥
  - âœ… FileManagerë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ íŒŒì¼ ì‘ì—… ìˆ˜í–‰

  ì €ì¥ êµ¬ì¡°:
  ./data/
  â”œâ”€â”€ book/
  â”‚   â”œâ”€â”€ {book-id-1}/
  â”‚   â”‚   â””â”€â”€ metadata.json    # Book ì „ì²´ ë°ì´í„°
  â”‚   â”œâ”€â”€ {book-id-2}/
  â”‚   â”‚   â””â”€â”€ metadata.json
  â”‚   â””â”€â”€ ...
  â””â”€â”€ image/
      â”œâ”€â”€ {book-id-1}/
      â”‚   â”œâ”€â”€ cover.png
      â”‚   â”œâ”€â”€ {page-id-1}.png
      â”‚   â””â”€â”€ {page-id-2}.png
      â””â”€â”€ ...

  ì£¼ìš” ë™ì‘:
  # ìƒì„±
  await file_repository.create(book)
  â†’ FileManager.save_book_metadata(book)
    â†’ JSON íŒŒì¼ë¡œ ì €ì¥

  # ì¡°íšŒ
  book = await file_repository.get(book_id)
  â†’ FileManager.load_book_metadata(book_id)
    â†’ JSON íŒŒì¼ ì½ê¸°

  # ì „ì²´ ì¡°íšŒ
  books = await file_repository.get_all()
  â†’ FileManager.scan_all_books()
    â†’ ëª¨ë“  metadata.json íŒŒì¼ ìŠ¤ìº”

  # ì‚­ì œ
  await file_repository.delete(book_id)
  â†’ FileManager.delete_book_metadata(book_id)
    â†’ JSON íŒŒì¼ ì‚­ì œ

  ---
  3ï¸âƒ£ InMemoryBookRepository (memory_repository.py)

  ì—­í• : ì¸ë©”ëª¨ë¦¬ ìºì‹± + íŒŒì¼ ë°±ì—… Repository

  íŠ¹ì§•:
  - âœ… Write-Through Cache ì „ëµ ì‚¬ìš©
  - âœ… FileBookRepositoryë¥¼ ê°ì‹¸ì„œ ìºì‹± ì œê³µ
  - âœ… ì„œë²„ ì¬ì‹œì‘ ì‹œ ìë™ ìºì‹œ ì›Œë°ì—…
  - âœ… ë¹ ë¥¸ ì½ê¸° ì„±ëŠ¥ (ë©”ëª¨ë¦¬ ì ‘ê·¼)

  ìºì‹œ êµ¬ì¡°:
  self._cache: Dict[str, Book] = {
      "book-id-1": Book(...),
      "book-id-2": Book(...),
      ...
  }

  ---
  ğŸ“Š ì£¼ìš” ë™ì‘ íë¦„

  CREATE (ë™í™”ì±… ìƒì„±)

  ì‚¬ìš©ì ìš”ì²­
      â”‚
      â–¼
  [API] POST /storybook/create
      â”‚
      â”œâ”€â†’ BookService.create_book_with_tts()
      â”‚   â”œâ”€â†’ ì´ë¯¸ì§€ ì €ì¥ (FileManager)
      â”‚   â”œâ”€â†’ TTS API í˜¸ì¶œ
      â”‚   â””â”€â†’ Book ê°ì²´ ìƒì„±
      â”‚
      â–¼
  [InMemoryBookRepository] create(book)
      â”‚
      â”œâ”€â†’ (1) FileBookRepository.create(book)
      â”‚       â””â”€â†’ FileManager.save_book_metadata(book)
      â”‚           â””â”€â†’ ğŸ“ ./data/book/{book_id}/metadata.json
      â”‚
      â””â”€â†’ (2) self._cache[book.id] = book  âœ… ìºì‹œ ì €ì¥

      âœ… ê²°ê³¼: íŒŒì¼ + ìºì‹œ ëª¨ë‘ ì €ì¥ë¨

  ---
  READ (ë™í™”ì±… ì¡°íšŒ)

  ê°œë³„ ì¡°íšŒ (GET /storybook/books/{book_id})

  ì‚¬ìš©ì ìš”ì²­
      â”‚
      â–¼
  [InMemoryBookRepository] get(book_id)
      â”‚
      â”œâ”€â†’ â“ book_id in self._cache?
      â”‚
      â”œâ”€â†’ YES (Cache HIT) âš¡
      â”‚   â””â”€â†’ return self._cache[book_id]
      â”‚       â””â”€â†’ ì¦‰ì‹œ ë°˜í™˜ (íŒŒì¼ I/O ì—†ìŒ)
      â”‚
      â””â”€â†’ NO (Cache MISS) ğŸ’¾
          â””â”€â†’ FileBookRepository.get(book_id)
              â””â”€â†’ FileManager.load_book_metadata(book_id)
                  â””â”€â†’ ğŸ“ ./data/book/{book_id}/metadata.json ì½ê¸°
                      â””â”€â†’ self._cache[book_id] = book  âœ… ìºì‹±
                          â””â”€â†’ return book

  ì „ì²´ ì¡°íšŒ (GET /storybook/books)

  ì‚¬ìš©ì ìš”ì²­
      â”‚
      â–¼
  [InMemoryBookRepository] get_all()
      â”‚
      â””â”€â†’ return list(self._cache.values())  âš¡
          â””â”€â†’ ìºì‹œì—ì„œ ì¦‰ì‹œ ë°˜í™˜ (íŒŒì¼ I/O ì—†ìŒ)

  ---
  UPDATE (ë™í™”ì±… ìˆ˜ì •)

  ì‚¬ìš©ì ìš”ì²­
      â”‚
      â–¼
  [InMemoryBookRepository] update(book_id, book)
      â”‚
      â”œâ”€â†’ â“ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      â”‚   â””â”€â†’ book_id in cache or file?
      â”‚
      â”œâ”€â†’ (1) FileBookRepository.update(book_id, book)
      â”‚       â””â”€â†’ FileManager.save_book_metadata(book)
      â”‚           â””â”€â†’ ğŸ“ ./data/book/{book_id}/metadata.json ë®ì–´ì“°ê¸°
      â”‚
      â””â”€â†’ (2) self._cache[book_id] = book  âœ… ìºì‹œ ê°±ì‹ 

      âœ… ê²°ê³¼: íŒŒì¼ + ìºì‹œ ëª¨ë‘ ì—…ë°ì´íŠ¸ë¨

  ---
  DELETE (ë™í™”ì±… ì‚­ì œ)

  ì‚¬ìš©ì ìš”ì²­
      â”‚
      â–¼
  [API] DELETE /storybook/books/{book_id}
      â”‚
      â”œâ”€â†’ (1) InMemoryBookRepository.delete(book_id)
      â”‚       â”‚
      â”‚       â”œâ”€â†’ FileBookRepository.delete(book_id)
      â”‚       â”‚   â””â”€â†’ FileManager.delete_book_metadata(book_id)
      â”‚       â”‚       â””â”€â†’ ğŸ“ ./data/book/{book_id}/ ì‚­ì œ
      â”‚       â”‚
      â”‚       â””â”€â†’ del self._cache[book_id]  âœ… ìºì‹œ ì‚­ì œ
      â”‚
      â””â”€â†’ (2) BookService.delete_book_files(book_id)
              â””â”€â†’ FileManager.delete_book_files(book_id)
                  â””â”€â†’ ğŸ“ ./data/image/{book_id}/ ì‚­ì œ

      âœ… ê²°ê³¼: íŒŒì¼ + ìºì‹œ + ì´ë¯¸ì§€ ëª¨ë‘ ì‚­ì œë¨

  ---
  ğŸš€ ì„œë²„ ì‹œì‘ ì‹œ (Lifespan)

  @asynccontextmanager
  async def lifespan(app: FastAPI):
      # Startup
      await book_repository.initialize_cache()
          â”‚
          â”œâ”€â†’ FileBookRepository.get_all()
          â”‚   â””â”€â†’ FileManager.scan_all_books()
          â”‚       â””â”€â†’ ğŸ“ ./data/book/**/metadata.json ëª¨ë‘ ìŠ¤ìº”
          â”‚
          â””â”€â†’ for book in books:
                  self._cache[book.id] = book  âœ… ìºì‹œ ì›Œë°ì—…

      yield  # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì¤‘

      # Shutdown
      # (ìºì‹œëŠ” ë©”ëª¨ë¦¬ì—ë§Œ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ì •ë¦¬ ë¶ˆí•„ìš”)

  ---
  ğŸ¯ Write-Through Cache ì „ëµ

  ì •ì˜: ì“°ê¸° ì‘ì—… ì‹œ ìºì‹œì™€ ì˜êµ¬ ì €ì¥ì†Œë¥¼ ë™ì‹œì— ì—…ë°ì´íŠ¸

  ì¥ì :
  - âœ… ë°ì´í„° ì¼ê´€ì„± ë³´ì¥: ìºì‹œì™€ íŒŒì¼ì´ í•­ìƒ ë™ê¸°í™”
  - âœ… ë¹ ë¥¸ ì½ê¸°: ëŒ€ë¶€ë¶„ì˜ ì½ê¸°ëŠ” ìºì‹œì—ì„œ ì²˜ë¦¬ (ë©”ëª¨ë¦¬ ì ‘ê·¼)
  - âœ… ì¥ì•  ë³µêµ¬: ì„œë²„ ì¬ì‹œì‘ í›„ íŒŒì¼ì—ì„œ ë³µì› ê°€ëŠ¥

  ë‹¨ì :
  - âš ï¸ ì“°ê¸° ì„±ëŠ¥ ì €í•˜: íŒŒì¼ I/Oê°€ í•„ìš”í•˜ë¯€ë¡œ ëŠë¦¼
  - âš ï¸ ë©”ëª¨ë¦¬ ì‚¬ìš©: ëª¨ë“  Bookì„ ë©”ëª¨ë¦¬ì— ì €ì¥

  ---
  ğŸ“ˆ ì„±ëŠ¥ íŠ¹ì„±

  ì½ê¸° (Read)

  - ìºì‹œ íˆíŠ¸: O(1) - ë”•ì…”ë„ˆë¦¬ ì¡°íšŒ âš¡
  - ìºì‹œ ë¯¸ìŠ¤: O(n) - íŒŒì¼ I/O ğŸ’¾

  ì“°ê¸° (Write)

  - ëª¨ë“  ê²½ìš°: O(n) - íŒŒì¼ I/O í•„ìˆ˜ ğŸ’¾

  ì„œë²„ ì‹œì‘

  - ì´ˆê¸° ë¡œë”©: O(N) - ëª¨ë“  íŒŒì¼ ìŠ¤ìº” ğŸ’¾

  ---
  ğŸ”® ì¶”í›„ í™•ì¥ ê°€ëŠ¥ì„±

  í˜„ì¬ Repository íŒ¨í„´ ë•ë¶„ì— ì‰½ê²Œ êµì²´ ê°€ëŠ¥:

  # í˜„ì¬: íŒŒì¼ ê¸°ë°˜
  book_repository = InMemoryBookRepository(
      file_repository=FileBookRepository(...)
  )

  # ì¶”í›„: PostgreSQL
  book_repository = PostgreSQLBookRepository(
      connection_string="postgresql://..."
  )

  # ì¶”í›„: MongoDB
  book_repository = MongoBookRepository(
      mongo_uri="mongodb://..."
  )

  API ì½”ë“œëŠ” ë³€ê²½ ì—†ì´ Repositoryë§Œ êµì²´í•˜ë©´ ë©ë‹ˆë‹¤!

  ---
  ìš”ì•½

  | êµ¬ì„± ìš”ì†Œ                  | ì—­í•           | ì €ì¥ì†Œ        | ì†ë„      |
  |------------------------|-------------|------------|---------|
  | InMemoryBookRepository | ìºì‹± ë ˆì´ì–´      | ë©”ëª¨ë¦¬ (Dict) | âš¡ ë§¤ìš° ë¹ ë¦„ |
  | FileBookRepository     | ì˜êµ¬ ì €ì¥       | íŒŒì¼ ì‹œìŠ¤í…œ     | ğŸ’¾ ëŠë¦¼   |
  | FileManager            | íŒŒì¼ I/O ìœ í‹¸ë¦¬í‹° | íŒŒì¼ ì‹œìŠ¤í…œ     | ğŸ’¾ ëŠë¦¼   |

  í•µì‹¬: Write-Through Cache ì „ëµìœ¼ë¡œ ë¹ ë¥¸ ì½ê¸° + ë°ì´í„° ì˜ì†ì„± ëª¨ë‘ í™•ë³´! ğŸ¯
